---
title: "BIOST537_Project"
author: "Dante Ramirez, Nada Ali, Jiayu Sun, Machi Kaneko"
date: '2023-03-13'
output:
  pdf_document: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE, warning = F, message = F}

library(tidyverse)
library(survival)
library(flexsurv)
library(msm)
library(survMisc)
library(muhaz)
library(kableExtra)
library(pander)
library(survminer)
library(data.table)

bmt_df <- read_csv(file = "~/BIOST537/BIOST537-Project/bmt.csv")

# create age at diagnosis variable in years
bmt_df$agediagnosis <- bmt_df$age - ((bmt_df$waittime)/365)

# create age at event (death, relapse or censoring) in years
bmt_df$ageevent <- bmt_df$agediagnosis + ((bmt_df$tdfs)/365)

```

**Directive 1**

```{r Directive 1, echo=FALSE}

# Creating Survival Object w/ delayed entry
s_bmt_de <- with(bmt_df, Surv(agediagnosis, ageevent, deltadfs==1))

# Creating Suvival Object w/o delayed entry
s_bmt <- with(bmt_df, Surv(tdfs, deltadfs == 1))

sfit_bmt <- survfit(s_bmt ~ 1, data = bmt_df, conf.type = "log-log")

# mean follow-up time
mean(bmt_df$tdfs)

# proportion of censored of observations
1 - mean(bmt_df$deltadfs)

# Kaplan Meier Plot
ggsurvplot(sfit_bmt,
           conf.int = TRUE,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate")

# Median Survival time, C.I. for median surivival time, and other summary stats
summary(sfit_bmt)$table

```

**Directive 2**

*Disease Subgrouping*

```{r Directive 2 part 1, echo=FALSE}

# Survival Object based on disease subgrouping
sfit_bmt_byDisgroup <- survfit(s_bmt ~ disgroup,
                               data = bmt_df,
                               conf.type = "log-log")


pander(survdiff(s_bmt ~ disgroup, data = bmt_df))

# Kaplan Meier curve
ggsurvplot(sfit_bmt_byDisgroup,
           pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by Disease Group")

#table 1: columns = disease groups, rows= baseline characteristics
bmt_df_dis <- bmt_df %>%
  group_by(disgroup) %>%
  summarise(mean_age = round(mean(age), 3),
            sd_age = round(sd(age), 3),
            count_males = sum(male),
            prop_males = round(sum(male) / length(male), 3),
            count_females = length(male) - sum(male),
            prop_females = round((length(male) - sum(male)) / length(male), 3),
            count_cmv = sum(cmv),
            prop_cmv = round(sum(cmv) / length(cmv), 3),
            count_mtx = sum(mtx),
            prop_mtx = round(sum(mtx) / length(mtx), 3),
            count_hospital = sum(hospital),
            mean_donor_age = round(mean(donorage), 3),
            sd_donor_age = round(sd(donorage), 3),
            count_donor_males = sum(donormale),
            prop_donor_males = round(sum(donormale) / length(donormale), 3),
            count_donor_cmv = sum(donorcmv),
            prop_donor_cmv = round(sum(donorcmv) / length(donorcmv), 3))

# Transposed plot for easier viewing
bmt_df_dis_t <- transpose(bmt_df_dis)
colnames(bmt_df_dis_t) <- c("Disease Group 1",
                             "Disease Group 2",
                             "Disease Group 3")
rownames(bmt_df_dis_t) <- colnames(bmt_df_dis)
bmt_df_dis_t <- bmt_df_dis_t[c(-1),]

kable(bmt_df_dis_t)

# For test statistics
test_stats_disgroup <- comp(ten(sfit_bmt_byDisgroup))

pchisq(q = (-1.95081)^2, df=1, lower.tail=FALSE)

```

*FAB Subgrouping*

```{r Directive 2 part 2, echo = F}

# Survival Object based on "When we was FAB" classification
sfit_bmt_byFAB <- survfit(s_bmt ~ fab,
                          data = bmt_df,
                          conf.type = "log-log")

pander(survdiff(s_bmt ~ fab, data = bmt_df))

ggsurvplot(sfit_bmt_byFAB,
           pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by FAB Group")

#table 2: columns = FAB classifications, rows = baseline characteristics
bmt_df_fab <- bmt_df %>%
  group_by(fab) %>%
  summarise(mean_age = round(mean(age), 3),
            sd_age = round(sd(age), 3),
            count_males = sum(male),
            prop_males = round(sum(male) / length(male), 3),
            count_females = length(male) - sum(male),
            prop_females = round((length(male) - sum(male)) / length(male), 3),
            count_cmv = sum(cmv),
            prop_cmv = round(sum(cmv) / length(cmv), 3),
            count_mtx = sum(mtx),
            prop_mtx = round(sum(mtx) / length(mtx), 3),
            count_hospital = sum(hospital),
            mean_donor_age = round(mean(donorage), 3),
            sd_donor_age = round(sd(donorage), 3),
            count_donor_males = sum(donormale),
            prop_donor_males = round(sum(donormale) / length(donormale), 3),
            count_donor_cmv = sum(donorcmv),
            prop_donor_cmv = round(sum(donorcmv) / length(donorcmv), 3))

# Transposed plot for easier viewing
bmt_df_fab_t <- transpose(bmt_df_fab)
colnames(bmt_df_fab_t) <- c("FAB Classification 1",
                             "FAB Classification 2")
rownames(bmt_df_fab_t) <- colnames(bmt_df_fab)
bmt_df_fab_t <- bmt_df_fab_t[c(-1),]

kable(bmt_df_fab_t)

test_stats_fabgroup <- comp(ten(sfit_bmt_byFAB))

pchisq(q = (2.6559)^2, df=1, lower.tail=FALSE)

```

**Directive 3**

*Sex Subgrouping*

```{r Directive 3 part 1, echo=FALSE}

# Survival Object based on sex subgrouping
sfit_bmt_byMale <- survfit(s_bmt ~ male,
                               data = bmt_df,
                               conf.type = "log-log")

# For log-rank test p-value
pander(survdiff(s_bmt ~ male, data = bmt_df))

ggsurvplot(sfit_bmt_byMale,
           pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by Sex")

```

*CMV Subgrouping*

```{r Directive 3 part 2, echo = F}

# Survival Object based on CMV subgrouping
sfit_bmt_byCMV <- survfit(s_bmt ~ cmv,
                               data = bmt_df,
                               conf.type = "log-log")

# For log-rank test p-value
pander(survdiff(s_bmt ~ cmv, data = bmt_df))

ggsurvplot(sfit_bmt_byCMV,
           pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by CMV")


```

*Donor Sex Subgrouping*

```{r Directive 3 part 3, echo = F}

# Survival Object based on sex subgrouping of donor
sfit_bmt_byDonerMale <- survfit(s_bmt ~ donormale,
                               data = bmt_df,
                               conf.type = "log-log")

# For log-rank test p-value
pander(survdiff(s_bmt ~ donormale, data = bmt_df))

ggsurvplot(sfit_bmt_byDonerMale,
           pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by Donor Sex")

```

*Donor CMV Subgrouping*

```{r Directive 3 part 4, echo = F}

# Survival Object based on CMV subgrouping of donor
sfit_bmt_byDonerCMV <- survfit(s_bmt ~ donorcmv,
                               data = bmt_df,
                               conf.type = "log-log")

# For log-rank test p-value
pander(survdiff(s_bmt ~ donorcmv, data = bmt_df))

ggsurvplot(sfit_bmt_byDonerCMV,
           pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by Donor CMV")

```

*Hospital Subgrouping*

```{r Directive 3 part 5, echo = F}

# Survival Object based on hospital subgrouping
sfit_bmt_byHospital <- survfit(s_bmt ~ hospital,
                               data = bmt_df,
                               conf.type = "log-log")

# For log-rank test p-value
pander(survdiff(s_bmt ~ hospital, data = bmt_df))

ggsurvplot(sfit_bmt_byHospital,
           pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by Hospital")

```

*MTX Subgrouping*

```{r Directive 3 part 6, echo=F}

# Survival Object based on mtx subgrouping
sfit_bmt_byMTX <- survfit(s_bmt ~ mtx,
                               data = bmt_df,
                               conf.type = "log-log")

# For log-rank test p-value
pander(survdiff(s_bmt ~ mtx, data = bmt_df))

ggsurvplot(sfit_bmt_byMTX,
           pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by MTX")

```

Two of the hospitals appear to be significant, but since each has little data, the power might be low, the SE might be high, and the CI may cross.

```{r Directive 4, echo = F}

summary(coxph(s_bmt ~ deltaa + age + cmv + donorcmv + strata(hospital),
              data=bmt_df))

s_relapse <- with(bmt_df, Surv(tdfs, deltar == 1))

summary(coxph(s_relapse ~ deltaa + age + cmv + donorcmv,
              data=bmt_df))

```



```{r Directive 5, echo = F}

s_gvhd <- with(bmt_df, Surv(ta, deltaa == 1))

gvhd <- survfit(s_gvhd ~ mtx, data = bmt_df, conf.type = "log-log")

ggsurvplot(gvhd, pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by MTX",
       xlab= "Time (in days)")

gvhdcmv <- survfit(s_gvhd ~ cmv,
                data = bmt_df,
                conf.type = "log-log")

ggsurvplot(gvhdcmv, pval = TRUE,
           pval.coord = c(2100, 1),
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by recipient CMV status",
       xlab= "Time (in days)")

gvhdhospital <- survfit(s_gvhd ~ hospital,
                   data = bmt_df,
                   conf.type = "log-log")

ggsurvplot(gvhdhospital, pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by Hospital",
       xlab= "Time (in days)")

gvhddonorcmv <- survfit(s_gvhd ~ donorcmv,
                        data = bmt_df,
                        conf.type = "log-log")

ggsurvplot(gvhddonorcmv, pval = TRUE,
           pval.coord = c(2100, 1),
           conf.int = F,
           surv.median.line = "hv") + 
  labs(title = "Kaplan-Meier survival estimate, by donor CMV statu",
       xlab= "Time (in days)")


```



```{r Directive 6, echo = F}

s_gvhd <- with(bmt_df, Surv(ta, deltaa == 1))

summary(coxph(s_gvhd ~ mtx + donorcmv + strata(hospital), data = bmt_df))

survfit_gvhdmtx <- survfit(s_gvhd ~ mtx, data=bmt_df, conf.type="log-log")


ggsurvplot(survfit_gvhdmtx)

summary(survfit_gvhdmtx, times=c(7, 14, 21, 28, 35, 42, 49, 56))

```



```{r Directive 7, echo = F}

summary(coxph(s_bmt ~ deltap + age + donorcmv + strata(hospital),
              data = bmt_df))

#Is it associated with a decreased risk of relapse? - no
summary(coxph(s_relapse ~ deltap + age + donorcmv + strata(hospital),
              data = bmt_df))

```


